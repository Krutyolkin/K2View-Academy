# **Fabric Batch Processes Architecture**

## **Fabric Batch Processes Flow** 
The execution of a new batch process automatically triggers a new entry in Cassandra, under k2viewsystem keyspace in the batch table. The batch process will be granted the following status: **WAITING_FOR_JOB**. This is because, in parallel, the execution of a new batch process automatically triggers a new job entry that is recorded in the k2viewsystem.jobs table with the following parameters:
- Name set to the name of the batch process.
- Type set to "BATCH PROCESS".

From there, any available node, or any node whose affinity has been specified in the batch command, will handle the execution of the Job and of the subcommand as specified in the batch command.

Once the corresponding JOB kicks off, and is set to **IN_PROCESS** stage, the batch process itself will move through the following stages:
1. NEW
2. GENERATE_IID
3. IN_PROGRESS
4. FAILED/CANCELLED/DONE
 

<img src="/articles/20_jobs_and_batch_services/images/13_jobs_and_batch_services_batch_process.PNG">



## **Scheduling Batch Processes**

It is not per-se possible possible to schedule a batch process to be executed at a given time, or recurrently. In order to achieve this, a scheduled process job will have to be created, and called with a script containing the batch command to be repeatidly invoked.
In fact, this consists in creating a Job that calls a Batch process which in turn will create multiple or scheduled one-time jobs with the execution parameters parsed in the batch command.

<img src="/articles/20_jobs_and_batch_services/images/14_jobs_and_batch_services_scheduled_batch_process.PNG">
 

## **Batch Process Table in Cassandra**
All batch related information will be found in the *k2batchprocess* keyspace in the *batchprocess_list* table;

### Example:

<img src="/articles/20_jobs_and_batch_services/images/15_jobs_and_batch_services_scheduled_batch_process.PNG">



<table width="900pxl">
<tbody>
<tr>
<td valign="top" width="300pxl">
<p><strong>Field</strong></p>
</td>
<td valign="top" width="400pxl">
<p><strong>Value</strong></p>
</td>
<td valign="top" width="400pxl">
<p><strong>Description</strong></p>
</td>

</tr>
<tr>
<td valign="top" width="300pxl">
<p><strong>bid</strong></p>
</td>
<td valign="top" width="400pxl">
<p>35408af6-b26a-4243-bc95-f114335bfa5e</p>
</td>
<td valign="top" width="400pxl">
<p>Unique ID generated by the system upon batch execution.</p>
</td>
 
 
</tr>
<tr>
<td valign="top" width="300pxl">
<p><strong>creation_time</strong></p>
</td>
<td valign="top" width="400pxl">
<p>2020-08-12 12:20:07.894000+0000</p>
</td>
<td valign="top" width="400pxl">
<p>timestamp of batch process creation</p>
</td>
</tr>

<tr>
<td valign="top" width="300pxl">
<p><strong>end_time</strong></p>
</td>
<td valign="top" width="400pxl">
<p>2020-08-12 12:20:09.176000+0000</p>
</td>
<td valign="top" width="400pxl">
<p>timestamp for the end of batch process</p>
</td>
</tr>

<tr>
<td valign="top" width="300pxl">
<p><strong>lut_name</strong></p>
</td>
<td valign="top" width="400pxl">
<p>AUTODATA_DELTA</p>
</td>
<td valign="top" width="400pxl">
<p>name of LUT for which instances are being retrieved</p>
</td>
</tr>


<tr>
<td valign="top" width="300pxl">
<p><strong>start_time</strong></p>
</td>
<td valign="top" width="400pxl">
<p>2020-08-12 12:20:07.907000+0000</p>
</td>
<td valign="top" width="400pxl">
<p>timestamp for the start of batch process</p>
</td>
</tr>


<tr>
<td valign="top" width="300pxl">
<p><strong>status</strong></p>
</td>
<td valign="top" width="400pxl">
<p>Done</p>
</td>
<td valign="top" width="400pxl">
<p>Stage of the batch process flow</p>
</td>
</tr>


<tr>
<td valign="top" width="300pxl">
<p><strong>total_entities</strong></p>
</td>
<td valign="top" width="400pxl">
<p>200</p>
</td>
<td valign="top" width="400pxl">
<p>Number of entities processed</p>
</td>
</tr>

</tbody>
</table>

<img src="/articles/20_jobs_and_batch_services/images/16_jobs_and_batch_services_scheduled_batch_table1.PNG">


arguments: 

```{"AUTH_TOKEN":"ws","FABRIC_COMMAND":"sync_instance AUTODATA_DELTA.?","JOB_UID":"BATCH AUTODATA_DELTA FROM idsFile USING ('select id from ids  limit 100') FABRIC_COMMAND=\"sync_instance AUTODATA_DELTA.?\" with async=trub9c7eb\",\"LOG_ID\":\"1000000000072\"}","SRC_DB_INTERFACE_NAME":"idsFile","AUTH_USER":"","sync_mode":"ON","INSTANCES_LIST":"","lu_name":"AUTODATA_DELTA","COMMAND":"BATCH AUTODATA_DELTA FROM idsFile USING ('select id from ids  limit 100') FABRIC_COMMAND=\"syn_Delta","SRC_DB_QUERY":"select id from ids  limit 100","environment_name":"_dev"}```

command: 

```BATCH AUTODATA_DELTA FROM idsFile USING ('select id from ids  limit 100') FABRIC_COMMAND="sync_instance AUTODATA_DELTA.?" with JOB_AFFINITY='10.21.2.102' ASYNC='true';``` - in this case a synchronization process of a list of IDs with affinity set to Node: 10.21.2.102 

<img src="/articles/20_jobs_and_batch_services/images/17_jobs_and_batch_services_scheduled_batch_table2.PNG">


extra_stats: 

```{"slowestProcessed":[{"entityId":"4","processTimeMS":572,"status":"COMPLETED","result":"{\"Added\":1,\"Updated\":0,\"Unchanged\":0}"},{"entityId":"5","processTimeMS":573,"status":"COMPLETED","result":"{\"Added\":1,\"Updated\":0,\"Unchanged\":0}"},{"entityId":"47","processTimeMS":645,"status":"COMPLETED","result":"{\"Added\":1,\"Updated\":0,\"Unchanged\":0}"}```

### **Batch Tables and Job Tables Correlation in Cassandra**
Information about the JOB that was created when executing the batch process will be found in the *k2system* keyspace, in the *k2_jobs* table.
Example:
The previous batch process can be seen in the job's table and its **output** field can be cross-referenced with the **bid** field in the batch table with :

<img src="/articles/20_jobs_and_batch_services/images/18_jobs_and_batch_services_scheduled_batch_table3.PNG">

## **Batch Process Execution**
- orchestrators



