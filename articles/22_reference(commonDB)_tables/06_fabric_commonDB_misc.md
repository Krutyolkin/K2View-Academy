

## CommonDB Table Initialization
When a new node is  coming up online, and rejoins the current Fabric cluster, all the common tables need to be brought to this node. Two options are available to perform this enrollment:

- **Option 1: Directly from kafka**

The new node connects directly to each kafka topics (one per reference table) to look whether a snapshot is available:

  -	the table is regularly sync-ed as per defined in its sync schedule and therefore a snapshot is available
  -	a snapshot has already been created due to a similar request generated by another node. 
  
  Note that in both cases, depending on the size of the update, the table's content will be synced either from the kafka message payload or from Cassandra's keyspace.


- **Option 2: From another node**

A new node comes on line and requests for an update:

  -	No snapshot is available on the corresponding Kafka topic. The new node requests for a snapshot to be created. 
  - The request is picked up by a node that in turn, prepares the snapshot and puts it either in kafka (short) or cassandra (long).
  - The new node waits for the snapshot by listening to the relevant Kafka queue message to be published by the node preparing the snapshot.


## Specific Cases Triggering Fabric Sessions Actions

### What Happens When I Deploy a Reference Table ?

Deploying a new reference table will have the following consequences:
1. All running reference table synchronization jobs will stop.
2  A new table/index will be created on CommonDB 
3. All Kafka Consumer/Topic will be cleared if the table was removed.
4. A new Kafka topic will be created if a new table was added.
5. A new Kafka consumer will be created for each node.
6. New sync jobs will be started (even if the deployment process failed so not to prevent existing synchronization processes).
7. All already existing configuration parameters are used (such as sync_job_retry_interval) on the [coordinating node](/articles/20_jobs_and_batch_services/17_batch_process_flow.md#step-1-1).


### What Happens When I Remove a Reference Table ?

- The Reference Table is dropped from CommonDB
-	All local topic consumers and producers on each node are dropped.

### What Happens When CommonDB is Dropped ?
When running the following command ```drop lutype k2_ref;``` from any Fabric Node the following will happen across the entire Fabric cluster:

- All existing tables in common.db are dropped.
- All existing sync jobs are stopped.
- All existing consumer / producers are terminated.



## Miscellaneous

- Kafka consumer and producer must be setup along with 2 SSL parameters, one for the consumer topic and one for the producer topic. 

- Updates can use either Kafka or happen in-memory depending on the project scope and in order to avoid unnecessary complexity at start. 
  - Mode for PoCs w/o kafka dependency
  - no data persistency needed
  
- Selecting and modifying data contained in Reference Tables can be done by setting the ```common_local_trx``` flag to TRUE, before running a commit.
    ```fabric>set COMMON_LOCAL_TRX=true;```
  
  - Using the [example](/articles/22_reference(commonDB)_tables/02_reference_table_fabric_studio.md#how-do-i-create-a-new-reference-table-in-fabric) defined earlier, and the DEVICESTABLE2017 Reference Table:
  - Enable Reference Table modification: ```fabric>set COMMON_LOCAL_TRX=true;```
  - Use the ```select``` command to view the row that needs modification:
  
    ```
    fabric>select TAC, BRANDMODEL  from DEVICESTABLE2017 where TAC=35156209;
    |TAC     |BRANDMODEL             |
    +--------+-----------------------+
    |35156209|GALAXY J3 2016 SM-J320F|
    ```

  - Start a transaction: ```fabric>begin;```
  - Using the ```update``` command, operate a change in the table: ```fabric>update DEVICESTABLE2017 set BRANDMODEL='GALAXY J3--2016 SM-J320F' where TAC=35156209;```
  - Check that the change was committed:
  
    ```
    fabric>select TAC, BRANDMODEL  from DEVICESTABLE2017 where TAC=35156209;
    |TAC     |BRANDMODEL              |
    +--------+------------------------+
    |35156209|GALAXY J3--2016 SM-J320F|
    ```
  - Close the transaction: ```fabric>end;```
  - Note that if you forget to close the transaction, write sessions to the Reference Table (such as a scheduled Sync) will not work.
  
   

[<img align="left" width="60" height="54" src="/articles/images/Previous.png">](/articles/22_reference%28commonDB%29_tables/04_commonDB_synch_modes_and_flow.md)

[<img align="right" width="60" height="54" src="/articles/images/Next.png">](/articles/22_reference%28commonDB%29_tables/06_fabric_commonDB_configuration.md)


   
